ТЗ на управление контакторами и контроль из состояния.

Устройство имеет три группы выходов по 9 в каждой: KMA1..9, KMB1..9, KMC1..9. Указанные порты управляют включением/отключением соответствующего контактора. Каждая группа относится к соответствующей фазе A, B или С. Активный уровень 0.

Устройство измеряет напряжение на выходе регулятора, то есть, оно должно включать нужную ступень регулирования так, чтобы измеренное напряжение всегда находилось в номинальных пределах. Шаг регулирования составляет 10В. Количество ступеней регулирования может быть разным в зависимости от аппаратной реализации, но не превышает 5. Количество ступеней должно быть жестко задано в прошивке и не должно меняться в ходе эксплуатации. Номинальное напряжение регулирования составляет от 220В до 240В и должно меняться в ходе эксплуатации, но не выходить за пределы 200..260В. Пределы должны храниться в энергонезависимой памяти, чтобы отсутствие связи с сервером не влияло на работу устройства.

Регулирование напряжения осуществляется в обе стороны, то есть, например, 5 ступеней означает возможность установить +10В, +20В, +30В, +40В, +50В, -10В, -20В, -30В, -40В, -50В и 0В (режим транзита) - всего 11 состояний.

В исходном состоянии после включения, устройство находится в режиме транзит, все контакторы выключены, напряжение на выходе соответствует напряжению на входе.

По результатам измерения, в случае, если напряжение выходит за пределы номинальных значений, контроллер включает ступень, соответствующую отклонению от номинального значения. 
Например, номинальное значение 220..240В. По результатам измерения напряжение равно 263В. Отклонение составляет 23В, то есть три ступени. Контроллер дает команду на включение третьей ступени на понижение. После включения соответствующей ступени, контроллер отправляет на сервер пакет о том, что текущая ступень изменилась и ее новое значение. Далее, измерение напряжения продолжается до его выхода за номинальные пределы вновь. На время переключения измерение напряжения не производится, так как результат может быть ошибочным из-за коммутации контакторов.

Возвращаясь к примеру, после включения третьей ступени, напряжение должно уменьшиться на 30В и стать 233В. Контроллер продолжает измерения до следующего выхода напряжения за пределы.

В случае повышения напряжения выше максимального никакие действия не предпринимаются, так как мы никак не можем повлиять на ситуацию и просто включаем максимальную ступень. А в случае понижения напряжения ниже 160В (на входе, определяется расчетным путем) необходимо перейти в транзит, так как ниже 160В не гарантируется работа контакторов.

Контактор - механический коммутационный элемент, который не всегда срабатывает надежно. Контактор может остаться в положении отпущен (не сработать), при подаче напряжения из-за обрыва катушки. Может зависнуть посредине из-за заклинивания. Может остаться в состоянии втянут (включен) при снятии управляющего напряжения из-за приваривания контактов. Для контроля правильности срабатывания у контактора имеются сигнальные нормально замкнутые и нормально разомкнутые контакты.

Выбор контролируемого контактора происходит через мультиплексор, управляемый линиями MX0..MX4, где MX0..MX3 выбирают одну из шестнадцати линий микросхем DD6 и DD8, а MX4 выбирает микросхему, 0 - DD8, 1 - DD6.
В исходном состоянии необходимо выбрать незадействованный вывод, например, DD8/Y14. Для этого надо установить выводы в следующем порядке: MX0=0, MX1=1, MX2=1, MX3=1, MX4=0.
активный уровень МХ0...МХ3 - единица, а МХ4 - 0 (Активный уровень - это единичка в адресе)
Процессор постоянно, с шагом 1мс, сканирует все линии MX0..MX4 поочередно, контролируя при этом состояние P1_IN, P2_IN. P1 соответствует нормально замкнутому контакту, P2 - нормально разомкнутому. Активный уровень на P1 и P2 - 0. То есть, после установки линий MX для контроля очередного контактора нужно выждать паузу 1мс для сглаживания переходных процессов и проверить состояние P. Если P1 = 0, P2 = 1, то контактор выключен. Если P1 = 1, P2 = 0, то контактор включен. Если P1 = 1, P2 = 1, то контактор в промежуточном состоянии (либо в процессе переключения, либо заклинил). Если P1 = 0, P2 = 0, то аппаратная ошибка, пробит оптрон, либо неверное подключение контактора.

Состояние контакторов необходимо контролировать постоянно, так как в работе у включенного контактора может отгореть катушка или возникнуть обрыв провода, а также, пробой ключа, управляющего контактором, поэтому, недостаточно контролировать состояние контактора только при переключении.

Линия DD8/Y15 контролирует источник питания +100В, этим напряжением производится контроль контакторов. Данный ключ заведен на P2. При отсутствии напряжения 100В контроль контакторов невозможен, следует выставить флаг ошибки, отключить все контакторы на всех фазах и прекратить регулирование на всех фазах.

В случае, неисправности любого контактора, также, выставить флаг ошибки, прекратить регулирование, отключить все контакторы, но только на той фазе, к которой относится неисправный контактор.

Время переключения контактора составляет не более 100мс, поэтому, при переключении любого контактора исключить контроль на время переключения.


Алгоритм переключения:
1) сначала перейти в транзит в любом случае, если только уже не в транзите


Переход в транзит происходит так:
- включить КМ2
- включить КМ3
- выключить КМ1
- выключить КМ2
- пауза 5 сек
- выключить КМ3

2) Контакторы КМ4-7 определяют ступень, а КМ8 - знак, повышение или понижение
Для ступени 1 и -1 КМ4..7 выключить
Для ступени 2 и -2 КМ4, КМ5 выключить, КМ6, КМ7 включить
Для ступени 3 и -3 КМ4 выключить, КМ5..7 включить
Для ступени 4 и -4 КМ4..КМ7 включить
Для повышающей ступени (напряжение меньше нормы) КМ8 выключить, для понижающей - КМ8 включить


Тут в общем то все просто, чем больше ступень, тем больше контакторов включено. Один нюанс, КМ6 и КМ7 работают параллельно. Ими и управлять можно было бы одним ключом, но по какой-то неясной причине сделали раздельные ключи для них

Для пятой ступени. Но пятую пока делать не будем, у нас сейчас 4-х ступенчатый вариант


3) Активация ступени (выход из транзита)
КМ2 включить
КМ3 включить
КМ1 включить
КМ2 выключить
Пауза 5с
КМ3 выключить

Т.е. мы должны для включения любой ступени:
1. Включить транзит
2. Включить ступень.
3 Выйти из транзита

Как можно заметить, само включение ступени в работу происходит когда включен КМ1

Если он выключен, то транзит будет всегда, ничего не будет добавляться и убавляться

Но нельзя просто так его (КМ1) включить или выключить
Потому что надо обеспечить непрерывность подачи энергии

Для этого, прежде чем поменять состояние КМ1, надо сначала включить КМ2, затем КМ3. После чего можно поменять состояние КМ1, после чего надо отключить КМ2, сделать паузу 5с и отключить КМ3.

Этот алгоритм одинаков и для входа в транзит и для включения ступени
